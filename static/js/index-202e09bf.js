var X=(v,_,x)=>new Promise((R,f)=>{var g=i=>{try{p(x.next(i))}catch(h){f(h)}},l=i=>{try{p(x.throw(i))}catch(h){f(h)}},p=i=>i.done?R(i.value):Promise.resolve(i.value).then(g,l);p((x=x.apply(v,_)).next())});import{d as oe,$ as Z,l as S,a1 as G,a9 as ue,cT as B,M as ae,b as n,o as b,c as A,u as a,D as E,w as e,e as t,q as r,F as J,f as s,a8 as K,B as de,C as _e,j as ne,aa as fe,cN as pe,aG as me,cL as he,aF as ve,aI as ge,aZ as ye,R as Q,U as W,s as Y,t as D,be as we,a6 as be}from"./index-6978caf2.js";import{c as ee}from"./chartEditStore-e9bb1111.js";import{i as L}from"./icon-7aaa208c.js";import{T as H,D as z}from"./index-68e3ab44.js";import{u as le}from"./useTargetData.hook-1838385f.js";import{M as xe}from"./EditorWorker-0774e479.js";import"./editorWorker-43a98755.js";import{g as Ce}from"./plugin-7d96af29.js";import{c as Se}from"./http-00faff26.js";import{F as te}from"./fileTypeEnum-21359a08.js";const P=v=>(de("data-v-eac7a30e"),v=v(),_e(),v),Fe=P(()=>r("p",null,[r("span",{class:"func-keyword"},"function"),s("  filter(data, res)  {")],-1)),Te={class:"go-ml-4"},ke=P(()=>r("p",null,"}",-1)),Re=s(" 编辑 "),Ee=s(" 删除 "),$e=s(" 新增过滤器 "),qe=s("过滤器函数编辑器"),Ie=P(()=>r("span",{class:"func-keyword"},"function",-1)),je=s("  filter(data, res)  { "),Ne=s("}"),Ue={class:"editor-data-show"},De=s("默认过滤数据(data)："),ze={class:"editor-data-show"},Be=s("接口返回数据(res)："),Ae={class:"editor-data-show"},Le=s("过滤器结果："),Me={class:"go-flex-items-center"},Oe=s(" 规则 "),Ve=s("过滤器默认处理接口返回值的「data」字段"),He=s("取消"),Ge=s("保存"),Je=oe({__name:"index",setup(v){const{DocumentTextIcon:_}=L.ionicons5,{FilterIcon:x,FilterEditIcon:R}=L.carbon,{targetData:f,chartEditStore:g}=le();Z(f.value.request),Z(g.getRequestGlobalConfig);const l=S(!1),p=S(f.value.filter||"return data"),i=S(!1),h=S(""),$=()=>X(this,null,function*(){try{const m=yield Se(K(f.value.request),K(g.getRequestGlobalConfig));if(m){h.value=m;return}window.$message.warning("没有拿到返回值，请检查接口！")}catch(m){console.error(m),window.$message.warning("数据异常，请检查参数！")}}),M=G(()=>{try{const m=new Function("data","res",p.value),y=ue(h.value),o=m(y==null?void 0:y.data,y);return i.value=!1,B(o)}catch(m){return i.value=!0,`过滤函数错误，日志：${m}`}}),I=()=>{l.value=!0},O=()=>{Ce({message:"是否删除过滤器",onPositiveCallback:()=>{f.value.filter=void 0}})},j=()=>{l.value=!1},N=()=>{if(i.value){window.$message.error("过滤函数错误，无法进行保存");return}f.value.filter=p.value,j()};return ae(()=>l.value,m=>{m&&($(),p.value=f.value.filter||"return data")}),(m,y)=>{const o=n("n-code"),c=n("n-icon"),d=n("n-button"),u=n("n-space"),C=n("n-card"),T=n("n-text"),k=n("n-tag"),q=n("n-divider"),U=n("n-scrollbar"),V=n("n-modal");return b(),A(J,null,[a(f).filter?(b(),E(C,{key:0},{footer:e(()=>[t(u,{justify:"end"},{default:e(()=>[t(d,{type:"primary",tertiary:"",size:"small",onClick:I},{icon:e(()=>[t(c,null,{default:e(()=>[t(a(R))]),_:1})]),default:e(()=>[Re]),_:1}),t(d,{tertiary:"",size:"small",onClick:O},{default:e(()=>[Ee]),_:1})]),_:1})]),default:e(()=>[Fe,r("div",Te,[t(o,{code:a(f).filter,language:"typescript"},null,8,["code"])]),ke]),_:1})):(b(),E(d,{key:1,class:"go-ml-3",onClick:I},{icon:e(()=>[t(c,null,{default:e(()=>[t(a(x))]),_:1})]),default:e(()=>[$e]),_:1})),t(V,{class:"go-chart-data-monaco-editor",show:l.value,"onUpdate:show":y[1]||(y[1]=F=>l.value=F),"mask-closable":!1,closeOnEsc:!1},{default:e(()=>[t(C,{bordered:!1,role:"dialog",size:"small","aria-modal":"true",style:{width:"1000px",height:"600px"}},{header:e(()=>[t(u,null,{default:e(()=>[t(T,null,{default:e(()=>[qe]),_:1})]),_:1})]),"header-extra":e(()=>[]),action:e(()=>[t(u,{justify:"space-between"},{default:e(()=>[r("div",Me,[t(k,{bordered:!1,type:"primary"},{icon:e(()=>[t(c,{component:a(_)},null,8,["component"])]),default:e(()=>[Oe]),_:1}),t(T,{class:"go-ml-2",depth:"2"},{default:e(()=>[Ve]),_:1})]),t(u,null,{default:e(()=>[t(d,{size:"medium",onClick:j},{default:e(()=>[He]),_:1}),t(d,{size:"medium",type:"primary",onClick:N},{default:e(()=>[Ge]),_:1})]),_:1})]),_:1})]),default:e(()=>[t(u,{size:"small",vertical:""},{default:e(()=>[t(u,{justify:"space-between"},{default:e(()=>[r("div",null,[t(u,{vertical:""},{default:e(()=>[t(k,{type:"info"},{default:e(()=>[Ie,je]),_:1}),t(a(xe),{modelValue:p.value,"onUpdate:modelValue":y[0]||(y[0]=F=>p.value=F),width:"460px",height:"380px",language:"javascript"},null,8,["modelValue"]),t(k,{type:"info"},{default:e(()=>[Ne]),_:1})]),_:1})]),t(q,{vertical:"",style:{height:"480px"}}),t(U,{style:{"max-height":"480px"}},{default:e(()=>[t(u,{size:15,vertical:""},{default:e(()=>[r("div",Ue,[t(u,null,{default:e(()=>{var F;return[t(T,{depth:"3"},{default:e(()=>[De]),_:1}),t(o,{code:a(B)((F=h.value)==null?void 0:F.data)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]}),_:1})]),r("div",ze,[t(u,null,{default:e(()=>[t(T,{depth:"3"},{default:e(()=>[Be]),_:1}),t(o,{code:a(B)(h.value)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),r("div",Ae,[t(u,null,{default:e(()=>[t(T,{depth:"3"},{default:e(()=>[Le]),_:1}),t(o,{code:a(M)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])],64)}}});const Pe=ne(Je,[["__scopeId","data-v-eac7a30e"]]),Xe=v=>{const _=S();return{uploadFileListRef:_,beforeUpload:({file:g})=>{_.value=[];const l=g.file.type;return l!==te.JSON&&l!==te.TXT?(window.$message.warning("仅支持上传 【JSON】 格式文件，请重新上传！"),!1):!0},customRequest:g=>{const{file:l}=g;fe(()=>{l.file?pe(l.file).then(p=>{v.value.option.dataset=me(p)}):window.$message.error("导入数据失败，请稍后重试或联系管理员！")})},download:()=>{try{window.$message.success("下载中，请耐心等待..."),he(ve(v.value.option.dataset),void 0,"json")}catch(g){window.$message.error("下载失败，数据错误！")}}}},Ze=s("无"),Ke=s("过滤器默认处理接口返回值的「data」字段"),Qe=s(" 导入（json / txt） "),We=s(" 下载 "),Ye=s("点击【下载】查看完整数据"),et=oe({__name:"index",props:{show:{type:Boolean,required:!1},ajax:{type:Boolean,required:!0}},setup(v){const{targetData:_}=le(),x=["字段","映射","状态"],{HelpOutlineIcon:R}=L.ionicons5,{DocumentAddIcon:f,DocumentDownloadIcon:g}=L.carbon,l=S(),p=S(),i=S(),h=S(!1),{uploadFileListRef:$,customRequest:M,beforeUpload:I,download:O}=Xe(_),j=G(()=>_.value.request.requestDataType!==ge.STATIC),N=G(()=>_.value.chartConfig.chartFrame===ee.ECHARTS),m=o=>{let c=z.SUCCESS;for(let d=0;d<l.value.length;d++)if(l.value[d][o]===void 0)return c=z.FAILURE,c;return z.SUCCESS},y=()=>{try{return p.value.map((o,c)=>c===0?{field:"通用标识",mapping:o,result:z.NULL}:{field:`数据项-${c}`,mapping:o,result:m(o)})}catch(o){return[]}};return ae(()=>{var o,c;return(c=(o=_.value)==null?void 0:o.option)==null?void 0:c.dataset},o=>{var c,d;o&&((d=(c=_==null?void 0:_.value)==null?void 0:c.chartConfig)==null?void 0:d.chartFrame)===ee.ECHARTS?(l.value=o,N.value&&(p.value=o.dimensions,i.value=y())):o!=null?(i.value=null,l.value=o):(h.value=!0,l.value="此组件无数据源"),ye(o)&&(i.value=null)},{immediate:!0}),(o,c)=>{const d=n("n-badge"),u=n("n-text"),C=n("n-space"),T=n("n-table"),k=n("n-timeline-item"),q=n("n-icon"),U=n("n-button"),V=n("n-upload"),F=n("n-tooltip"),se=n("n-code"),ce=n("n-card"),re=n("n-timeline");return b(),E(re,{class:"go-chart-configurations-timeline"},{default:e(()=>[Q(t(k,{type:"info",title:a(H).MAPPING},{default:e(()=>[t(T,{striped:""},{default:e(()=>[r("thead",null,[r("tr",null,[(b(),A(J,null,Y(x,w=>r("th",{key:w},D(w),1)),64))])]),r("tbody",null,[(b(!0),A(J,null,Y(i.value,(w,ie)=>(b(),A("tr",{key:ie},[r("td",null,D(w.field),1),r("td",null,D(w.mapping),1),r("td",null,[w.result===0?(b(),E(C,{key:0},{default:e(()=>[t(d,{dot:"",type:"success"}),t(u,null,{default:e(()=>[Ze]),_:1})]),_:1})):(b(),E(C,{key:1},{default:e(()=>[t(d,{dot:"",type:w.result===1?"success":"error"},null,8,["type"]),t(u,null,{default:e(()=>[s("匹配"+D(w.result===1?"成功":"失败"),1)]),_:2},1024)]),_:2},1024))])]))),128))])]),_:1})]),_:1},8,["title"]),[[W,a(N)&&i.value]]),Q(t(k,{color:"#97846c",title:a(H).FILTER},{default:e(()=>[t(C,{size:18,vertical:""},{default:e(()=>[t(u,{depth:"3"},{default:e(()=>[Ke]),_:1}),t(a(Pe))]),_:1})]),_:1},8,["title"]),[[W,a(j)]]),t(k,{type:"success",title:a(H).CONTENT},{default:e(()=>[t(C,{vertical:""},{default:e(()=>[t(C,{class:"source-btn-box"},{default:e(()=>[t(V,{"file-list":a($),"onUpdate:file-list":c[0]||(c[0]=w=>we($)?$.value=w:null),"show-file-list":!1,customRequest:a(M),onBeforeUpload:a(I)},{default:e(()=>[t(C,null,{default:e(()=>[v.ajax?be("",!0):(b(),E(U,{key:0,class:"sourceBtn-item",disabled:h.value},{icon:e(()=>[t(q,null,{default:e(()=>[t(a(f))]),_:1})]),default:e(()=>[Qe]),_:1},8,["disabled"]))]),_:1})]),_:1},8,["file-list","customRequest","onBeforeUpload"]),r("div",null,[t(U,{class:"sourceBtn-item",disabled:h.value,onClick:a(O)},{icon:e(()=>[t(q,null,{default:e(()=>[t(a(g))]),_:1})]),default:e(()=>[We]),_:1},8,["disabled","onClick"]),t(F,{trigger:"hover"},{trigger:e(()=>[t(q,{class:"go-ml-1",size:"21",depth:3},{default:e(()=>[t(a(R))]),_:1})]),default:e(()=>[t(u,{depth:"3"},{default:e(()=>[Ye]),_:1})]),_:1})])]),_:1}),t(ce,{size:"small"},{default:e(()=>[t(se,{code:a(B)(l.value),language:"json"},null,8,["code"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1})}}});const _t=ne(et,[["__scopeId","data-v-f6d90859"]]);export{_t as C};
